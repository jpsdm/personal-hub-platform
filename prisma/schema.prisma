// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  password     String?  // Optional password for profile protection
  avatarColor  String   @default("#3B82F6") // Color for user avatar
  timezone     String   @default("America/Sao_Paulo") // User timezone for date display
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  accounts        Account[]
  categories      Category[]
  tags            Tag[]
  transactions    Transaction[]
  
  // Workstation relations
  kanbanBoards     KanbanBoard[]
  tasks            Task[]
  pomodoroSessions PomodoroSession[]
  timeEntries      TimeEntry[]
  
  // Investment relations
  portfolios       Portfolio[]
}

model Account {
  id             String   @id @default(uuid())
  userId         String
  name           String
  isDefault      Boolean  @default(false)
  initialBalance Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
}

model Category {
  id        String   @id @default(uuid())
  userId    String?
  name      String
  type      String   // INCOME or EXPENSE
  isDefault Boolean  @default(false)
  color     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@index([type])
}

model Tag {
  id        String   @id @default(uuid())
  userId    String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions TransactionOnTags[]

  @@index([userId])
}

model Transaction {
  id              String    @id @default(uuid())
  userId          String
  accountId       String
  categoryId      String
  type            String    // INCOME or EXPENSE
  description     String
  amount          Float
  dueDate         DateTime  // Data base (para transações únicas) ou data de início (para recorrentes/parcelas)
  paidDate        DateTime?
  status          String    // PENDING, PAID, OVERDUE
  notes           String?   // Observações
  isRecurring     Boolean   @default(false)
  isFixed         Boolean   @default(false)  // Despesa fixa (aparece todo mês indefinidamente)
  installments    Int?      // Número total de parcelas (ex: 12 para 12x)
  
  // Campos para transações virtuais
  startDate       DateTime? // Data de início para parcelas/fixas (se diferente de dueDate)
  endDate         DateTime? // Data final para parcelas (calculada: startDate + installments meses)
  dayOfMonth      Int?      // Dia do mês para recorrência (1-31)
  
  // Override: quando usuário edita uma ocorrência específica de transação virtual
  isOverride            Boolean   @default(false)  // True se é um override de ocorrência específica
  overrideForDate       DateTime? // Data da ocorrência que este registro sobrescreve
  parentTransactionId   String?   // ID da transação pai (para overrides ou cancelamentos)
  
  // Cancelamento de ocorrência específica
  cancelledOccurrences  String[]  // Lista de datas canceladas (formato: "2025-01", "2025-02")
  
  // Legado (manter para compatibilidade durante migração)
  currentInstallment Int?   // Será removido após migração
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  account       Account               @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category      Category              @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tags          TransactionOnTags[]

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([dueDate])
  @@index([status])
  @@index([type])
  @@index([parentTransactionId])
  @@index([isFixed])
  @@index([installments])
  @@index([isOverride])
}

model TransactionOnTags {
  transactionId String
  tagId         String

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([transactionId, tagId])
  @@index([transactionId])
  @@index([tagId])
}

// ==========================================
// WORKSTATION MODULE
// ==========================================

model KanbanBoard {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  color       String   @default("#3B82F6")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  columns KanbanColumn[]
  tasks   Task[]

  @@index([userId])
}

model KanbanColumn {
  id        String   @id @default(uuid())
  boardId   String
  name      String
  color     String   @default("#6B7280")
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board KanbanBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([boardId])
  @@index([order])
}

model Task {
  id          String    @id @default(uuid())
  userId      String
  boardId     String
  columnId    String
  code        String    // Código de rastreio (ex: TASK-001)
  title       String
  description String?
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  dueDate     DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  board           KanbanBoard       @relation(fields: [boardId], references: [id], onDelete: Cascade)
  column          KanbanColumn      @relation(fields: [columnId], references: [id], onDelete: Cascade)
  pomodoroSessions PomodoroSession[]
  timeEntries     TimeEntry[]

  @@unique([boardId, code])
  @@index([userId])
  @@index([boardId])
  @@index([columnId])
  @@index([order])
}

model PomodoroSession {
  id          String    @id @default(uuid())
  userId      String
  taskId      String?   // Pode ser null se não estiver vinculado a uma task
  startedAt   DateTime
  endedAt     DateTime?
  duration    Int       @default(0) // Duração em segundos
  type        String    @default("WORK") // WORK, SHORT_BREAK, LONG_BREAK
  status      String    @default("RUNNING") // RUNNING, PAUSED, COMPLETED, CANCELLED
  pausedAt    DateTime? // Quando foi pausado
  pausedTime  Int       @default(0) // Tempo total pausado em segundos
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([taskId])
  @@index([startedAt])
  @@index([status])
}

model TimeEntry {
  id          String   @id @default(uuid())
  userId      String
  taskId      String?
  description String?
  startedAt   DateTime
  endedAt     DateTime
  duration    Int      // Duração em segundos
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([taskId])
  @@index([startedAt])
}

// ==========================================
// INVESTMENTS MODULE
// ==========================================

model Portfolio {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  color       String   @default("#3B82F6")
  currency    String   @default("BRL")
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  investments Investment[]

  @@index([userId])
}

model Asset {
  id          String   @id @default(uuid())
  symbol      String   @unique    // Ex: "PETR4", "BTCUSD", "HGLG11"
  name        String              // Ex: "Petrobras PN"
  type        String              // STOCK, FII, CRYPTO, ETF, FIXED_INCOME, FUND
  exchange    String?             // B3, NASDAQ, BINANCE, etc.
  sector      String?             // Tecnologia, Financeiro, etc.
  currency    String   @default("BRL")
  logoUrl     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  investments  Investment[]
  priceHistory AssetPriceHistory[]

  @@index([type])
  @@index([symbol])
}

model Investment {
  id            String    @id @default(uuid())
  portfolioId   String
  assetId       String
  quantity      Float                // Quantidade de ativos
  averagePrice  Float                // Preço médio de compra
  totalInvested Float                // Total investido (quantity * averagePrice)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  portfolio    Portfolio             @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset        Asset                 @relation(fields: [assetId], references: [id], onDelete: Restrict)
  transactions InvestmentTransaction[]

  @@unique([portfolioId, assetId])  // Apenas um registro por ativo por carteira
  @@index([portfolioId])
  @@index([assetId])
}

model InvestmentTransaction {
  id            String   @id @default(uuid())
  investmentId  String
  type          String              // BUY, SELL, DIVIDEND, SPLIT, BONUS
  quantity      Float
  price         Float               // Preço unitário na transação
  totalValue    Float               // Valor total (quantity * price)
  fees          Float    @default(0) // Taxas e corretagem
  date          DateTime
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([date])
  @@index([type])
}

model AssetPriceHistory {
  id        String   @id @default(uuid())
  assetId   String
  date      DateTime @db.Date
  open      Float?
  high      Float?
  low       Float?
  close     Float
  volume    Float?
  createdAt DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, date])
  @@index([assetId])
  @@index([date])
}
